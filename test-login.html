<!DOCTYPE html>
<html>
<head>
    <title>üö® TESTE CR√çTICO - Supabase Schema Fix</title>
    <style>
        body { font-family: 'Courier New', monospace; margin: 40px; background: #1a1a1a; color: #00ff00; }
        .container { max-width: 1200px; margin: 0 auto; }
        .result { margin-top: 20px; padding: 20px; border-radius: 8px; border: 2px solid; }
        .success { background: #0d4f0d; color: #00ff00; border-color: #00ff00; }
        .error { background: #4f0d0d; color: #ff4444; border-color: #ff4444; }
        .warning { background: #4f4f0d; color: #ffff00; border-color: #ffff00; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; }
        button { padding: 15px 30px; font-size: 18px; margin: 10px 5px; background: #333; color: #00ff00; border: 2px solid #00ff00; cursor: pointer; }
        button:hover { background: #00ff00; color: #000; }
        input { padding: 12px; margin: 5px; width: 300px; background: #333; color: #00ff00; border: 1px solid #00ff00; }
        .header { text-align: center; border: 3px solid #ff4444; padding: 20px; margin-bottom: 30px; }
        .status { display: flex; gap: 20px; margin-bottom: 20px; }
        .status-item { flex: 1; padding: 10px; border: 1px solid #666; text-align: center; }
        .step-log { background: #2a2a2a; padding: 10px; margin: 10px 0; border-left: 4px solid #00ff00; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® SUPABASE SCHEMA FIX - TESTE CR√çTICO</h1>
            <p><strong>PROBLEMA:</strong> Database error granting user - POST /auth/v1/token 500</p>
            <p><strong>CORRE√á√ïES:</strong> RLS Policies + Trigger + Schema Validation</p>
        </div>
        
        <div class="status" id="statusBar">
            <div class="status-item">‚è≥ Aguardando teste...</div>
        </div>
        
        <div>
            <input type="email" id="email" placeholder="Email do Admin" value="armazemsaojoaquimoficial@gmail.com">
            <input type="password" id="password" placeholder="Senha" value="admin123">
            <button onclick="testLogin()">üöÄ EXECUTAR TESTE CR√çTICO</button>
            <button onclick="testSchema()">üîç VERIFICAR SCHEMA</button>
        </div>
        
        <div id="logs"></div>
        <div id="result"></div>
    </div>
    
    <script>
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            logsDiv.innerHTML += `<div class="step-log ${logClass}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
        }
        
        function updateStatus(status) {
            document.getElementById('statusBar').innerHTML = `<div class="status-item">${status}</div>`;
        }
        
        async function testSchema() {
            addLog('üîç Iniciando verifica√ß√£o de schema...', 'info');
            updateStatus('üîç Verificando schema...');
            
            try {
                const response = await fetch('/api/test-supabase', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog('‚úÖ Schema b√°sico OK', 'success');
                } else {
                    addLog(`‚ùå Problema no schema: ${data.error}`, 'error');
                }
                
                document.getElementById('result').innerHTML = `
                    <div class="result ${data.success ? 'success' : 'error'}">
                        <h3>üìä Resultado Verifica√ß√£o Schema:</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                addLog(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('result');
            
            addLog('üöÄ INICIANDO TESTE CR√çTICO DE LOGIN...', 'info');
            updateStatus('üöÄ Executando teste cr√≠tico...');
            
            resultDiv.innerHTML = '<div class="result warning">‚è≥ Executando teste cr√≠tico de autentica√ß√£o...</div>';
            
            try {
                addLog(`üîç Testando login para: ${email}`, 'info');
                
                const response = await fetch('/api/test-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog('‚úÖ LOGIN FUNCIONANDO! Schema corrigido com sucesso!', 'success');
                    updateStatus('‚úÖ TESTE PASSOU - Schema Corrigido!');
                    
                    addLog(`‚úÖ Usu√°rio: ${data.user.email}`, 'success');
                    addLog(`‚úÖ Profile Role: ${data.profile.role}`, 'success');
                    addLog(`‚úÖ Admin Role: ${data.admin.role || 'N/A'}`, 'success');
                    addLog(`‚úÖ Session: ${data.session.accessToken}`, 'success');
                } else {
                    addLog(`‚ùå TESTE FALHOU: ${data.error}`, 'error');
                    addLog(`‚ùå Etapa: ${data.step || 'N/A'}`, 'error');
                    updateStatus('‚ùå TESTE FALHOU - Verificar logs');
                }
                
                const resultClass = data.success ? 'success' : 'error';
                resultDiv.innerHTML = `
                    <div class="result ${resultClass}">
                        <h3>${data.success ? 'üéØ SUCESSO - SCHEMA FUNCIONANDO!' : 'üö® FALHA NO TESTE'}</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                addLog(`‚ùå ERRO CR√çTICO: ${error.message}`, 'error');
                updateStatus('‚ùå ERRO CR√çTICO - Servidor n√£o responde');
                
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>üö® ERRO CR√çTICO NA REQUISI√á√ÉO:</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
        
        // Auto-executar teste na inicializa√ß√£o
        window.onload = () => {
            addLog('üåü Sistema de teste carregado. Pronto para executar!', 'info');
            setTimeout(() => {
                testLogin();
            }, 2000);
        };
    </script>
</body>
</html>